- name: Deploy Nginx and Monitoring Stack
  hosts: unixhosts
  become: yes
  vars:
    ECR_REPO_URL: "yelucpp/devops_workflow_integration_repo"
    NGINX_PORT: "8081"
    # Variables for Grafana authentication - to be passed as extra vars
    # GRAFANA_URL: "http://localhost:3000"
    # GRAFANA_USER: "admin"
    # GRAFANA_PASSWORD: "admin"
    
  tasks:
    - name: Install docker
      shell: sudo snap install docker

    # --- Monitoring Components Installation ---

    - name: Install community.grafana collection (Requires Ansible 2.9+)
      ansible.builtin.command: ansible-galaxy collection install community.grafana
      ignore_errors: yes 

    - name: Install Prometheus, Grafana, and Node Exporter (using Docker containers)
      community.docker.docker_container:
        name: "{{ item.name }}"
        image: "{{ item.image }}"
        published_ports: "{{ item.ports }}"
        volumes: "{{ item.volumes | default([]) }}"
        restart_policy: always
        # Node Exporter requires host network or specific volume mounts
        network_mode: "{{ item.network_mode | default('bridge') }}" 
        command: "{{ item.command | default('') }}"
      loop:
        - name: prometheus
          image: prom/prometheus:latest
          ports: ["9090:9090"]
          volumes: 
            - /home/leon/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
          network_mode: bridge

        - name: grafana
          image: grafana/grafana:latest
          ports: ["3000:3000"]
          volumes: 
            # Mount the datasource configuration file
            - /home/leon/grafana/provisioning/datasources/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml
            # Mount a persistent volume for Grafana data (optional but recommended)
            - grafana_data:/var/lib/grafana
          env:
            GF_SECURITY_ADMIN_PASSWORD: "{{ GRAFANA_PASSWORD | default('admin') }}" 
            GF_AUTH_ANONYMOUS_ENABLED: "true" 
            GF_AUTH_ANONYMOUS_ORG_ROLE: "Admin"
          network_mode: bridge 

        - name: node-exporter # <--- NEW EXPORTER ADDED HERE
          image: prom/node-exporter:latest
          ports: ["9100:9100"]
          # Use host network mode to gather host metrics
          network_mode: host 
          volumes: 
            # Mount necessary host paths as read-only volumes for metric collection
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /:/rootfs:ro
          command: 
            - --path.procfs=/host/proc 
            - --path.sysfs=/host/sys
            - --collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($|/)


    # --- Prometheus and Grafana Configuration ---

    - [cite_start]name: Ensure configuration directories exist [cite: 5]
      ansible.builtin.file:
        path: "/home/leon/{{ item }}"
        state: directory
        owner: leon
        group: leon
        mode: '0755'
      loop:
        - prometheus
        - grafana/provisioning/datasources

    - [cite_start]name: Copy prometheus.yml to VM [cite: 5]
      ansible.builtin.copy:
        src: prometheus.yml
        dest: /home/leon/prometheus/prometheus.yml

    - [cite_start]name: Copy datasource.yml to VM [cite: 5]
      ansible.builtin.copy:
        src: datasource.yml
        dest: /home/leon/grafana/provisioning/datasources/datasource.yml

    # --- Docker Nginx Deployment Tasks (Existing) ---

    - [cite_start]name: Stop and remove old container [cite: 5]
      community.docker.docker_container:
        name: web-server
        state: absent

    - [cite_start]name: Remove an image [cite: 5]
      community.docker.docker_image_remove:
        name: "{{ ECR_REPO_URL }}:latest"

    - [cite_start]name: Log into Docker Hub [cite: 5]
      community.docker.docker_login:
        username: "{{ DOCKERHUB_USERNAME }}"
        password: "{{ DOCKERHUB_PASSWORD }}"

    - [cite_start]name: Pull latest image [cite: 5]
      community.docker.docker_image_pull:
        name: "{{ ECR_REPO_URL }}:latest"

    - [cite_start]name: Deploy container [cite: 5]
      community.docker.docker_container:
        name: web-server
        image: "{{ ECR_REPO_URL }}:latest"
        published_ports: "{{ NGINX_PORT }}:80"
        # Optional: Add network to allow containers to talk
        network_mode: host 

    - [cite_start]name: Check if web server is responding [cite: 5]
      ansible.builtin.uri:
        url: "http://localhost:{{ NGINX_PORT }}"
        status_code: 200
      register: http_check
      failed_when: false
      changed_when: false

    - [cite_start]name: Display web server status [cite: 5]
      ansible.builtin.debug:
        msg: "Web server is {{ 'up' if http_check.status == 200 else 'down' }}"
